image: docker:stable

services:
  - docker:dind

variables:
  DOCKER_HOST   : tcp://docker:2375
  DOCKER_DRIVER : overlay2

before_script:
  - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com

build:
  stage: build
  script:
    - VERSION=$(cat version)
    - NAME=$(registry.gitlab.com/clouddrove/www)
    - TAG=$($NAME:$VERSION)
    - LATEST=$($NAME:latest)
    - echo $VERSION
    - echo $LATEST
    - echo $TAG
    - echo $NAME
    - docker login -u gitlab-ci-token -p $GITLAB_TOKEN registry.gitlab.com
    - docker build -t $TAG .
    - docker tag $TAG $LATEST
    - docker push $TAG
    - docker push $LATEST
